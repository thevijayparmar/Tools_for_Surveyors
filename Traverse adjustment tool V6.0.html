<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Traverse Adjustment Tool ‚Äî Neumorphism</title><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script><style>:root{--bg:#e8edf5;--fg:#232a3e;--muted:#6b7280;--neu-dark:#c3c9d3;--neu-light:#fff;--blue:#1d4ed8}html,body{height:100%}body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}.container{max-width:1200px;margin:24px auto 80px;padding:0 16px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.title{font-size:clamp(20px,3vw,34px);font-weight:800;margin:8px 0 0}.neu{background:var(--bg);border-radius:18px;box-shadow:12px 12px 24px var(--neu-dark),-12px -12px 24px var(--neu-light)}.neu-inset{background:var(--bg);border-radius:14px;box-shadow:inset 8px 8px 16px var(--neu-dark),inset -8px -8px 16px var(--neu-light)}.pill{padding:10px 16px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;background:var(--bg);box-shadow:6px 6px 12px var(--neu-dark),-6px -6px 12px var(--neu-light);cursor:pointer;border:0;color:var(--fg);font-weight:600}.primary{color:#fff;background:linear-gradient(145deg,#4f8ffb,#2f6be8);box-shadow:8px 8px 16px rgba(0,0,0,.12),-6px -6px 14px rgba(255,255,255,.5)}.danger{background:#fdecec;color:#b91c1c}.grid{display:grid;gap:16px}.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:1fr 1fr 1fr}@media(max-width:900px){.grid.cols-3{grid-template-columns:1fr}}@media(max-width:780px){.grid.cols-2{grid-template-columns:1fr}}.card{padding:18px;position:relative}.section-title{font-weight:700;margin:2px 0 8px}.muted{color:var(--muted);font-size:13px}input[type=text],select{width:100%;padding:10px 12px;border:none;outline:none;color:var(--fg);background:var(--bg);border-radius:12px;box-shadow:inset 6px 6px 12px var(--neu-dark),inset -6px -6px 12px var(--neu-light)}input[type=file]{border:none}input[type=checkbox]{transform:scale(1.1)}.toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.alert{margin:8px 0;padding:10px 12px;border-radius:12px;background:#fee2e2;color:#991b1b;box-shadow:inset 6px 6px 12px #e3b9b9,inset -6px -6px 12px #fff}.hidden{display:none}table{width:100%;border-collapse:separate;border-spacing:0 8px}thead th{text-align:left;font-size:13px;color:var(--muted);padding:8px 10px;position:sticky;top:0;background:var(--bg)}tbody tr{background:var(--bg);box-shadow:6px 6px 12px var(--neu-dark),-6px -6px 12px var(--neu-light);border-radius:12px}tbody tr:nth-child(even){filter:brightness(.98)}tbody td{padding:8px 10px}.cell{min-width:70px;padding:8px 10px;border-radius:10px;background:var(--bg);box-shadow:inset 4px 4px 8px var(--neu-dark),inset -4px -4px 8px var(--neu-light)}.cell[contenteditable=true]:focus{outline:2px solid #93c5fd}.drag-handle{cursor:grab;user-select:none;padding:4px 8px}.drag-handle:active{cursor:grabbing}.scroll{max-height:380px;overflow:auto;border-radius:14px}.tableBox{position:relative}.dlbtn{position:absolute;right:10px;top:10px;width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;background:#fff7d6;box-shadow:6px 6px 12px rgba(0,0,0,.12),-6px -6px 12px rgba(255,255,255,.7);display:grid;place-items:center}.dlbtn:after{content:"‚¨á";font-size:16px}.statbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}.stat{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:var(--bg);box-shadow:6px 6px 12px var(--neu-dark),-6px -6px 12px var(--neu-light);font-weight:800}.stat.blue{color:var(--blue)}#sketchBox{position:relative}#tip{position:absolute;pointer-events:none;background:var(--bg);padding:8px 10px;border-radius:10px;box-shadow:6px 6px 12px var(--neu-dark),-6px -6px 12px var(--neu-light);font-size:12px;display:none;white-space:nowrap}canvas{width:100%;height:420px;display:block;border-radius:16px}.footer-credit{position:fixed;right:18px;bottom:14px;font-size:12px;color:#6b7280;background:var(--bg);padding:8px 12px;border-radius:12px;box-shadow:6px 6px 12px var(--neu-dark),-6px -6px 12px var(--neu-light)}.right{text-align:right}.nowrap{white-space:nowrap}</style></head><body><div class="container"><div class="header"><div class="title">Traverse Adjustment Tool</div><button class="pill danger" onclick="resetTool()">Reset</button></div><div class="grid cols-2"><div class="card neu" id="modeCard"><div class="section-title">1) Choose Input Type</div><div class="grid cols-2"><label class="pill" onclick="setMode('bearing')"><input type="radio" name="mode" id="modeBearing"/><span>üìê Bearing + Distance</span></label><label class="pill" onclick="setMode('coords')"><input type="radio" name="mode" id="modeCoords"/><span>üó∫Ô∏è Coordinates</span></label></div><div id="coordsSubOptions" class="" style="margin-top:12px"><div class="section-title">Coordinate Entry Mode</div><div class="grid cols-3"><label class="pill" onclick="setCoordSub('manual')"><input type="radio" name="coordSub" id="coordManual"/><span>Manual</span></label><label class="pill" onclick="setCoordSub('csv')"><input type="radio" name="coordSub" id="coordCSV"/><span>CSV Upload</span></label><label class="pill" onclick="setCoordSub('sample')"><input type="radio" name="coordSub" id="coordSample"/><span>Sample Test Data</span></label></div><div id="sampleWrap" class="hidden" style="margin-top:8px"><div class="grid cols-2"><div><div class="muted">Choose test set</div><select id="sampleSelect"></select></div><div class="right" style="align-self:end"><button class="pill" onclick="loadSample()">Load Sample</button></div></div><div class="muted" style="margin-top:6px">Instant demo without input. Edit rows after loading.</div></div></div></div><div class="card neu"><div class="section-title">2) Settings</div><div class="grid cols-2"><label class="pill"><input type="checkbox" id="assumeClosed" checked/><span>Assume Closed Traverse</span></label><label class="pill"><input type="checkbox" id="angleAzimuth" checked/><span>Angle is Azimuth (0‚Äì360¬∞)</span></label><label class="pill"><input type="radio" name="coordSys" id="sysUTM" checked onchange="setCoordSys('utm')"/><span>UTM / Projected</span></label><label class="pill"><input type="radio" name="coordSys" id="sysGCS" onchange="setCoordSys('gcs')"/><span>GCS (Lon/Lat)</span></label></div><div class="muted" style="margin-top:8px">Angles: <b>decimal degrees only</b>. In GCS, distances use <b>Haversine</b>; bearings are geodetic. Closure uses a local East/North approximation for small extents.</div></div></div><div class="card neu" style="margin-top:16px" id="sketchTile"><div class="section-title">3) Sketch</div><div class="muted">Click a point for (ID, X, Y, Bearing). Click a segment for length. Red vector = misclosure.</div><div id="sketchBox" class="neu-inset" style="padding:10px"><canvas id="sketch" width="1100" height="420"></canvas><div id="tip"></div></div><div class="statbar"><div id="statMis" class="stat">Misclosure eX=‚Äî, eY=‚Äî</div><div id="statRes" class="stat">Resultant ‚Äî</div><div id="statRat" class="stat">Ratio ‚Äî</div><div id="statPeri" class="stat blue">Perimeter ‚Äî</div><div id="statArea" class="stat blue">Area ‚Äî</div></div><div id="commentary" class="muted" style="margin-top:8px"></div></div><div class="card neu" style="margin-top:16px"><div class="section-title">4) Data</div><div id="dataError" class="alert hidden"></div><div id="bearingPanel" class="hidden"><div class="grid cols-3" style="margin-bottom:12px"><div><div class="muted" id="startXLabel">Start X (Easting)</div><input type="text" id="startX" placeholder="e.g., 5000"/></div><div><div class="muted" id="startYLabel">Start Y (Northing)</div><input type="text" id="startY" placeholder="e.g., 8000"/></div><div class="toolbar"><button class="pill primary" onclick="addBearingRow()">+ Add Leg</button><label class="pill"><input type="checkbox" id="bearingMaster" onclick="toggleAll('bearing')"/> <span>Select/Deselect All</span></label><button class="pill" onclick="clearBearing()">Clear</button></div></div><div class="neu-inset tableBox" style="padding:12px"><button class="dlbtn" title="Export Legs CSV" onclick="exportCSV('legs')"></button><div class="scroll"><table><thead><tr><th style="width:32px"></th><th style="width:34px"><input type="checkbox" onclick="toggleAll('bearing',this.checked)"/></th><th style="width:80px">Leg ID</th><th style="width:130px">Length</th><th style="width:160px">Angle (¬∞)</th></tr></thead><tbody id="bearingTBody"></tbody></table></div></div></div><div id="coordsPanel" class=""><div class="toolbar" style="margin-bottom:10px"><button class="pill primary" onclick="addCoordRow()">+ Add Row</button><label class="pill"><input type="checkbox" id="coordsMaster" onclick="toggleAll('coords')"/> <span>Select/Deselect All</span></label><input class="pill" type="file" id="csvFile" accept=".csv" onchange="onCSVChosen(event)"/></div><div id="mapInline" class="neu-inset hidden" style="padding:10px;margin-bottom:10px"><div class="grid cols-3"><div><div class="muted" id="mxLabel">Map X *</div><select id="mapX"></select></div><div><div class="muted" id="myLabel">Map Y *</div><select id="mapY"></select></div><div><div class="muted">Point ID (optional)</div><select id="mapId"></select></div></div><div class="right" style="margin-top:10px"><button class="pill" onclick="applyMapping(true)">Apply Mapping</button></div><div id="mapMsg" class="muted" style="margin-top:6px"></div></div><div class="neu-inset tableBox" style="padding:12px"><button class="dlbtn" title="Export Points CSV" onclick="exportCSV('points')"></button><div class="scroll"><table><thead><tr><th style="width:32px"></th><th style="width:34px"><input type="checkbox" onclick="toggleAll('coords',this.checked)"/></th><th style="width:120px">Point ID (opt)</th><th style="width:160px"><span id="xHeader">X (Easting)</span></th><th style="width:160px"><span id="yHeader">Y (Northing)</span></th></tr></thead><tbody id="coordsTBody"></tbody></table></div></div><div class="grid cols-2" style="margin-top:12px"><div class="neu-inset log" id="logBox">Ready.</div><div class="right"><button class="pill primary" onclick="recompute(true)">Compute & Adjust</button></div></div></div></div><div class="card neu" style="margin-top:16px"><div class="section-title">5) Results</div><div id="resultsError" class="alert hidden"></div><div id="resultsTables"><div class="grid cols-2"><div class="neu-inset tableBox" style="padding:12px"><button class="dlbtn" title="Export Legs CSV" onclick="exportCSV('legs')"></button><div class="section-title">Legs ‚Äî Original vs Adjusted</div><div class="muted">Corrections per leg. Bearings in azimuth (¬∞ from North).</div><div class="scroll"><table><thead><tr><th>#</th><th>Length</th><th>Bearing ¬∞</th><th>ŒîX</th><th>ŒîY</th><th>Corr ŒîX</th><th>Corr ŒîY</th><th>Adj Len</th><th>Adj Bearing ¬∞</th><th>ŒîŒ∏ (¬∞)</th></tr></thead><tbody id="legsTableBody"></tbody></table></div></div><div class="neu-inset tableBox" style="padding:12px"><button class="dlbtn" title="Export Points CSV" onclick="exportCSV('points')"></button><div class="section-title">Points ‚Äî Original vs Adjusted</div><div class="muted">Corrections shown as Œ¥X, Œ¥Y per vertex.</div><div class="scroll"><table><thead><tr><th>#</th><th>Point ID</th><th>Orig X</th><th>Orig Y</th><th>Adj X</th><th>Adj Y</th><th>Œ¥X</th><th>Œ¥Y</th></tr></thead><tbody id="pointsTableBody"></tbody></table></div><div id="summaryBox" class="muted" style="margin-top:10px"></div></div></div></div></div></div><div class="footer-credit">¬© Vijay Parmar</div><script>let mode='coords',coordSub='manual',coordSys='utm';const bearingRows=[],coordRows=[];let csvHeaders=[],csvRows=[],mapping={id:null,x:null,y:null};let last={origLegs:[],adjLegs:null,origPts:[],adjPts:null,stats:{eX:0,eY:0,misclosure:0,Lsum:0},prec:{x:3,y:3,len:3,ang:2}};let recomputeTimer=null;const samples={Triangle:[["P1",0,0],["P2",50,0],["P3",25,43.3]],Rectangle:[["P1",0,0],["P2",100,0],["P3",100,50],["P4",0,50]],Pentagon:[["P1",0,0],["P2",60,0],["P3",90,40],["P4",45,80],["P5",0,40]],"Random shape 1":[["A",10.12,5.4],["B",67.7,8.2],["C",80.5,52.9],["D",33.3,78.6],["E",-5.8,40.2]],"Random shape 2":[["K1",-20,10],["K2",35,12],["K3",55,60],["K4",10,90],["K5",-30,55],["K6",-10,20]]};const $=id=>document.getElementById(id);const log=(m,t='info')=>{const el=$('logBox');const ti=new Date().toLocaleTimeString();const ic=t==='error'?'‚õî':t==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è';el.textContent=`${ic} [${ti}] ${m}`};const toNum=v=>{if(v==null)return NaN;if(typeof v==='number')return v;const s=String(v).trim();if(!s)return NaN;return parseFloat(s.replace(/,/g,''))};const decs=s=>{const m=String(s??'').trim().match(/\.(\d+)/);return m?m[1].length:0};const clampAngle=a=>{let r=a%360;if(r<0)r+=360;return r};const parseAngle=i=>{if(typeof i==='number')return clampAngle(i);const s=String(i||'').trim();if(!s)return NaN;const n=Number(s);return Number.isFinite(n)?clampAngle(n):NaN};const rad=d=>d*Math.PI/180,deg=r=>r*180/Math.PI;const bearingFromDXDY=(dx,dy)=>clampAngle(deg(Math.atan2(dx,dy)));const sum=a=>a.reduce((x,y)=>x+y,0);function pretty(n,places){if(n==null||Number.isNaN(n))return'‚Äî';return Number(n).toFixed(places)}function computePrecision(){let px=0,py=0,pl=0,pa=0;coordRows.forEach(r=>{px=Math.max(px,decs(r.xStr??r.x));py=Math.max(py,decs(r.yStr??r.y))});bearingRows.forEach(r=>{pl=Math.max(pl,decs(r.lengthStr??r.length));pa=Math.max(pa,decs(r.angleStr??r.angleDeg))});last.prec={x:Math.max(px,3),y:Math.max(py,3),len:Math.max(pl,3),ang:Math.max(pa,2)}}function scheduleRecompute(adjust){clearTimeout(recomputeTimer);recomputeTimer=setTimeout(()=>recompute(!!adjust),200)}function setCoordSys(s){coordSys=s;updateCoordLabels();scheduleRecompute(false)}function updateCoordLabels(){const xH=$('xHeader'),yH=$('yHeader'),sx=$('startXLabel'),sy=$('startYLabel'),mx=$('mxLabel'),my=$('myLabel');if(coordSys==='utm'){xH&&(xH.textContent='X (Easting)');yH&&(yH.textContent='Y (Northing)');sx&&(sx.textContent='Start X (Easting)');sy&&(sy.textContent='Start Y (Northing)');mx&&(mx.textContent='Map X (Easting) *');my&&(my.textContent='Map Y (Northing) *')}else{xH&&(xH.textContent='Longitude (X)');yH&&(yH.textContent='Latitude (Y)');sx&&(sx.textContent='Start Longitude (X)');sy&&(sy.textContent='Start Latitude (Y)');mx&&(mx.textContent='Map Longitude (X) *');my&&(my.textContent='Map Latitude (Y) *')}}function setMode(m){mode=m;$('modeBearing').checked=(m==='bearing');$('modeCoords').checked=(m==='coords');$('bearingPanel').classList.toggle('hidden',m!=='bearing');$('coordsPanel').classList.toggle('hidden',m!=='coords');$('coordsSubOptions').classList.toggle('hidden',m!=='coords');scheduleRecompute(false)}function setCoordSub(s){coordSub=s;$('coordManual').checked=(s==='manual');$('coordCSV').checked=(s==='csv');$('coordSample').checked=(s==='sample');$('sampleWrap').classList.toggle('hidden',s!=='sample');if(s==='csv')$('csvFile').click();if(s==='sample')fillSampleSelect()}function fillSampleSelect(){const sel=$('sampleSelect');sel.innerHTML='';Object.keys(samples).forEach(k=>sel.appendChild(new Option(k,k)))}function loadSample(){setMode('coords');coordRows.length=0;const key=$('sampleSelect').value||Object.keys(samples)[0];(samples[key]||[]).forEach(r=>coordRows.push({include:true,id:r[0],x:r[1],y:r[2],xStr:String(r[1]),yStr:String(r[2])}));renderCoordTable();log('Loaded sample: '+key);scheduleRecompute(false)}function renderBearingTable(){const tb=$('bearingTBody');tb.innerHTML='';bearingRows.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td class="nowrap"><span class="drag-handle">‚ò∞</span></td><td><input type="checkbox" ${r.include?'checked':''} onchange="(bearingRows[${i}].include=this.checked,scheduleRecompute(false))"></td><td><div class="cell" contenteditable oninput="(bearingRows[${i}].id=this.textContent.trim(),scheduleRecompute(false))">${r.id??''}</div></td><td><div class="cell" contenteditable oninput="(bearingRows[${i}].lengthStr=this.textContent,bearingRows[${i}].length=toNum(this.textContent),scheduleRecompute(false))">${r.lengthStr??r.length??''}</div></td><td><div class="cell" contenteditable oninput="(bearingRows[${i}].angleStr=this.textContent,bearingRows[${i}].angleDeg=parseAngle(this.textContent),scheduleRecompute(false))">${r.angleStr??r.angleDeg??''}</div></td>`;tb.appendChild(tr)});Sortable.create(tb,{handle:'.drag-handle',animation:150,onEnd:e=>{const[m]=bearingRows.splice(e.oldIndex,1);bearingRows.splice(e.newIndex,0,m);renderBearingTable();scheduleRecompute(false)}})}const addBearingRow=()=>{bearingRows.push({include:true,id:'',length:null,lengthStr:'',angleDeg:null,angleStr:''});renderBearingTable();scheduleRecompute(false)};const clearBearing=()=>{bearingRows.length=0;renderBearingTable();scheduleRecompute(false)};function renderCoordTable(){const tb=$('coordsTBody');tb.innerHTML='';coordRows.forEach((r,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td class="nowrap"><span class="drag-handle">‚ò∞</span></td><td><input type="checkbox" ${r.include?'checked':''} onchange="(coordRows[${i}].include=this.checked,scheduleRecompute(false))"></td><td><div class="cell" contenteditable oninput="(coordRows[${i}].id=this.textContent.trim(),scheduleRecompute(false))">${r.id??''}</div></td><td><div class="cell" contenteditable oninput="(coordRows[${i}].xStr=this.textContent,coordRows[${i}].x=toNum(this.textContent),scheduleRecompute(false))">${r.xStr??r.x??''}</div></td><td><div class="cell" contenteditable oninput="(coordRows[${i}].yStr=this.textContent,coordRows[${i}].y=toNum(this.textContent),scheduleRecompute(false))">${r.yStr??r.y??''}</div></td>`;tb.appendChild(tr)});Sortable.create(tb,{handle:'.drag-handle',animation:150,onEnd:e=>{const[m]=coordRows.splice(e.oldIndex,1);coordRows.splice(e.newIndex,0,m);renderCoordTable();scheduleRecompute(false)}})}const addCoordRow=()=>{coordRows.push({include:true,id:'',x:null,y:null,xStr:'',yStr:''});renderCoordTable();scheduleRecompute(false)};const clearCoords=()=>{coordRows.length=0;renderCoordTable();scheduleRecompute(false)};function toggleAll(which,val){if(which==='bearing'){bearingRows.forEach(r=>r.include=(typeof val==='boolean'?val:$('bearingMaster').checked));renderBearingTable()}else{coordRows.forEach(r=>r.include=(typeof val==='boolean'?val:$('coordsMaster').checked));renderCoordTable()}scheduleRecompute(false)}function onCSVChosen(e){const f=e.target.files?.[0];if(!f){log('No file selected');return}if(mode!=='coords')setMode('coords');Papa.parse(f,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:(res)=>{csvHeaders=res.meta.fields||[];csvRows=res.data||[];setupInlineMapping()},error:(err)=>log('CSV parse error: '+err.message)})}function setupInlineMapping(){const map=$('mapInline');map.classList.remove('hidden');const fill=(id,cands)=>{const sel=$(id);sel.innerHTML='';sel.appendChild(new Option('‚Äî',''));csvHeaders.forEach(h=>sel.appendChild(new Option(h,h)));sel.value=autoPick(csvHeaders,cands)};fill('mapX',["x","e","east","easting","lon","longitude"]);fill('mapY',["y","n","north","northing","lat","latitude"]);fill('mapId',["id","name","pt","point","pid","code","label"]);$('mapMsg').textContent='Review auto‚Äëdetected mapping, then Apply.'}function autoPick(headers,cands){const L=headers.map(h=>h.toLowerCase());for(const c of cands){const i=L.indexOf(c);if(i>=0)return headers[i]}for(const [i,h]of headers.entries()){const l=h.toLowerCase();if(cands.some(c=>l.includes(c)))return headers[i]}return''}function applyMapping(){const mx=$('mapX')?.value,my=$('mapY')?.value,mid=$('mapId')?.value||null;if(!mx||!my){$('mapMsg').textContent='Select X and Y columns to import.';showError('dataError','CSV loaded: waiting for column mapping (X & Y required).');return}mapping={id:mid||null,x:mx,y:my};coordRows.length=0;let added=0;csvRows.forEach(r=>{const xStr=String(r[mx]),yStr=String(r[my]);const x=toNum(xStr),y=toNum(yStr);if(Number.isNaN(x)||Number.isNaN(y))return;const id=mid?String(r[mid]):'';coordRows.push({include:true,id,x,y,xStr,yStr});added++});renderCoordTable();$('mapMsg').textContent=`Imported ${added} row(s).`;showError('dataError','');scheduleRecompute(false)}function buildFromBearing(){computePrecision();const sx=toNum($('startX').value),sy=toNum($('startY').value);if(Number.isNaN(sx)||Number.isNaN(sy)){showError('dataError','Enter valid Start X and Start Y for bearing mode (decimal only).');return{points:[],legs:[]}}const legs=[];for(const r of bearingRows){if(!r.include)continue;const L=toNum(r.length),A=parseAngle(r.angleDeg);if(Number.isNaN(L)||L<=0||Number.isNaN(A))continue;const dx=L*Math.sin(rad(A)),dy=L*Math.cos(rad(A));legs.push({id:r.id||'',length:L,bearing:A,dx,dy})}const pts=[{id:'START',x:sx,y:sy}];let cx=sx,cy=sy;for(const lg of legs){cx+=lg.dx;cy+=lg.dy;pts.push({id:'',x:cx,y:cy})}return{points:pts,legs}}function buildFromCoords(){computePrecision();const inc=coordRows.filter(r=>r.include&&!Number.isNaN(toNum(r.x))&&!Number.isNaN(toNum(r.y)));if(!inc.length){showError('dataError','Need at least two valid coordinates to compute closure.');return{points:coordRows.filter(r=>!Number.isNaN(toNum(r.x))&&!Number.isNaN(toNum(r.y))).map(r=>({x:toNum(r.x),y:toNum(r.y)})),legs:[]}}let invalid=0;const pts=inc.map(r=>{const x=toNum(r.x),y=toNum(r.y);if(coordSys==='gcs'&&!(x>=-180&&x<=180&&y>=-90&&y<=90))invalid++;return{id:r.id||'',x,y}});if(invalid>0)showError('dataError',`${invalid} row(s) outside valid GCS range (lon -180..180, lat -90..90).`);else showError('dataError','');const legs=[];if(coordSys==='gcs'){const R=6371000;const phi0=rad(pts.reduce((a,p)=>a+p.y,0)/pts.length);const mPerDegLat=Math.PI*R/180;const mPerDegLon=Math.PI*R/180*Math.cos(phi0);for(let i=0;i<pts.length-1;i++){const a=pts[i],b=pts[i+1];const dphi=rad(b.y-a.y),dl=rad(b.x-a.x),phi1=rad(a.y),phi2=rad(b.y);const hav=2*R*Math.asin(Math.sqrt(Math.sin(dphi/2)**2+Math.cos(phi1)*Math.cos(phi2)*Math.sin(dl/2)**2));const y=Math.sin(dl)*Math.cos(phi2);const x=Math.cos(phi1)*Math.sin(phi2)-Math.sin(phi1)*Math.cos(phi2)*Math.cos(dl);const brg=clampAngle(deg(Math.atan2(y,x)));const dx=(b.x-a.x)*mPerDegLon,dy=(b.y-a.y)*mPerDegLat;legs.push({id:`${a.id||i+1}->${b.id||i+2}`,length:hav,bearing:brg,dx,dy})}}else{for(let i=0;i<pts.length-1;i++){const dx=pts[i+1].x-pts[i].x,dy=pts[i+1].y-pts[i].y;const L=Math.hypot(dx,dy),B=bearingFromDXDY(dx,dy);legs.push({id:`${pts[i].id||i+1}->${pts[i+1].id||i+2}`,length:L,bearing:B,dx,dy})}}return{points:pts,legs}}function bowditchAdjust(legs){const Lsum=sum(legs.map(l=>l.length)),eX=sum(legs.map(l=>l.dx)),eY=sum(legs.map(l=>l.dy));const adj=legs.map(l=>{const cX=-eX*(l.length/Lsum),cY=-eY*(l.length/Lsum);const dx2=l.dx+cX,dy2=l.dy+cY;const L2=Math.hypot(dx2,dy2),B2=bearingFromDXDY(dx2,dy2);const d=clampAngle(B2-l.bearing),dtheta=d>180?d-360:d;return{...l,cX,cY,dx2,dy2,L2,B2,dtheta}});return{adj,eX,eY,Lsum,misclosure:Math.hypot(eX,eY)}}const legsToPoints=(start,legs)=>{const pts=[{...start}],p={x:start.x,y:start.y};for(const l of legs){p.x+=l.dx2;p.y+=l.dy2;pts.push({x:p.x,y:p.y})}return pts};function legsToRelativePoints(legs){const pts=[{x:0,y:0}];let x=0,y=0;for(const l of legs){x+=l.dx;y+=l.dy;pts.push({x,y})}return pts}function polygonArea(pts){if(!pts||pts.length<3)return 0;let A=0;for(let i=0;i<pts.length;i++){const p=pts[i],q=pts[(i+1)%pts.length];A+=p.x*q.y-q.x*p.y}return Math.abs(A/2)}function recompute(apply){try{const assume=$('assumeClosed').checked;let source,start;if(mode==='bearing'){source=buildFromBearing();start=source.points[0]||{x:0,y:0}}else if(mode==='coords'){source=buildFromCoords();start=source.points[0]||{x:0,y:0}}else{showError('dataError','Select an input mode.');return}const legs=source.legs;last.origPts=source.points;last.origLegs=legs;if(!legs.length){drawSketch(source.points,null,{eX:0,eY:0,misclosure:0,Lsum:0});updateTables([],[],{eX:0,eY:0,misclosure:0,Lsum:0});updateStats({eX:0,eY:0,misclosure:0,Lsum:0},source.points);return}const eX=sum(legs.map(l=>l.dx)),eY=sum(legs.map(l=>l.dy)),mis=Math.hypot(eX,eY),Lsum=sum(legs.map(l=>l.length));let stats={eX,eY,misclosure:mis,Lsum};if(apply&&assume){const r=bowditchAdjust(legs);const adjPts=legsToPoints({x:start.x,y:start.y},r.adj);last.adjLegs=r.adj;last.adjPts=adjPts;stats={eX:r.eX,eY:r.eY,misclosure:r.misclosure,Lsum:r.Lsum};drawSketch(source.points,adjPts,stats);updateTables(legs,r.adj,stats)}else{last.adjLegs=null;last.adjPts=null;drawSketch(source.points,null,stats);updateTables(legs,[],stats)}last.stats=stats;updateStats(stats,source.points)}catch(err){showError('resultsError','Computation error: '+err.message)}}function updateTables(orig,adj,stats){const px=last.prec.x,py=last.prec.y,pl=last.prec.len,pa=last.prec.ang;const lb=$('legsTableBody');lb.innerHTML='';orig.forEach((o,i)=>{const a=adj[i];const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${pretty(o.length,pl)}</td><td>${pretty(o.bearing,pa)}</td><td>${pretty(o.dx,px)}</td><td>${pretty(o.dy,py)}</td><td>${a?pretty(a.cX,px):'‚Äî'}</td><td>${a?pretty(a.cY,py):'‚Äî'}</td><td>${a?pretty(a.L2,pl):'‚Äî'}</td><td>${a?pretty(a.B2,pa):'‚Äî'}</td><td>${a?pretty(a.dtheta,pa):'‚Äî'}</td>`;lb.appendChild(tr)});const pb=$('pointsTableBody');pb.innerHTML='';const oPtsAbs=last.origPts&&last.origPts.length?last.origPts.map(p=>({x:p.x,y:p.y,id:p.id||''})):(function(){let x=0,y=0;const a=[{x,y,id:''}];for(const l of orig){x+=l.dx;y+=l.dy;a.push({x,y,id:''})}return a})();let aPtsAbs=(last.adjPts&&last.adjPts.length)?last.adjPts.map(p=>({x:p.x,y:p.y})):null;for(let i=0;i<oPtsAbs.length;i++){const o=oPtsAbs[i],a=aPtsAbs?aPtsAbs[i]:null,pid=(coordRows[i]&&coordRows[i].id)||o.id||'';const tr=document.createElement('tr');tr.innerHTML=`<td>${i+1}</td><td>${pid}</td><td>${pretty(o.x,px)}</td><td>${pretty(o.y,py)}</td><td>${a?pretty(a.x,px):'‚Äî'}</td><td>${a?pretty(a.y,py):'‚Äî'}</td><td>${a?pretty(a.x-o.x,px):'‚Äî'}</td><td>${a?pretty(a.y-o.y,py):'‚Äî'}</td>`;pb.appendChild(tr)}$('resultsError').classList.add('hidden')}function updateStats(st,pts){const px=last.prec.x,py=last.prec.y;const mis=pretty(st.misclosure,Math.max(last.prec.len,3));const eX=pretty(st.eX,px),eY=pretty(st.eY,py);const ratio=st.misclosure?pretty(st.Lsum/st.misclosure,1):'‚àû';$('statMis').textContent=`Misclosure eX=${eX}, eY=${eY}`;$('statRes').textContent=`Resultant ${mis}`;$('statRat').textContent=`Ratio 1:${ratio}`;const useAdj=!!(last.adjLegs&&last.adjLegs.length);const legs=useAdj?last.adjLegs:last.origLegs;const per=sum(legs.map(l=>useAdj?l.L2:l.length));const relPts=useAdj?(function(){const p=[{x:0,y:0}];let x=0,y=0;for(const l of last.adjLegs){x+=l.dx2;y+=l.dy2;p.push({x,y})}return p})():legsToRelativePoints(legs);const area=polygonArea(relPts);$('statPeri').textContent=`Perimeter ${pretty(per,Math.max(last.prec.len,3))}`;$('statArea').textContent=`Area ${pretty(area,Math.max(last.prec.len,3))}`;const bb=bounds(pts);const spread=Math.hypot(bb.maxX-bb.minX,bb.maxY-bb.minY);let msg='';if(pts.length<3)msg+='Few points ‚Äî closure judgement may be unreliable. ';if(st.misclosure>0.1*spread)msg+='‚ö† Error is large vs survey extent; possible missing leg or wrong input. ';if(!msg)msg='Looks consistent for the given extent.';$('commentary').textContent=msg}function showError(id,msg){const el=$(id);if(!msg){el.classList.add('hidden');el.textContent='';return}el.textContent=msg;el.classList.remove('hidden')}function bounds(arr){let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;for(const p of arr){if(p.x<minX)minX=p.x;if(p.x>maxX)maxX=p.x;if(p.y<minY)minY=p.y;if(p.y>maxY)maxY=p.y}if(minX===Infinity){minX=maxX=minY=maxY=0}return{minX,minY,maxX,maxY}}function exportCSV(which){let csv='';if(which==='legs'){csv+='index,length,bearing,dx,dy,corr_dx,corr_dy,adj_length,adj_bearing,dtheta\n';(last.origLegs||[]).forEach((o,i)=>{const a=last.adjLegs?last.adjLegs[i]:null;csv+=`${i+1},${o.length},${o.bearing},${o.dx},${o.dy},${a?a.cX:''},${a?a.cY:''},${a?a.L2:''},${a?a.B2:''},${a?a.dtheta:''}\n`})}else{csv+='index,point_id,orig_x,orig_y,adj_x,adj_y,delta_x,delta_y\n';const oPts=(last.origPts&&last.origPts.length)?last.origPts:(function(){let x=0,y=0;const a=[{x,y}];(last.origLegs||[]).forEach(l=>{x+=l.dx;y+=l.dy;a.push({x,y})});return a})();const aPts=(last.adjPts&&last.adjPts.length)?last.adjPts:null;for(let i=0;i<oPts.length;i++){const o=oPts[i],a=aPts?aPts[i]:{};const pid=(coordRows[i]&&coordRows[i].id)||'';csv+=`${i+1},${pid},${o.x},${o.y},${a.x??''},${a.y??''},${a.x!=null?a.x-o.x:''},${a.y!=null?a.y-o.y:''}\n`}}const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=which+'_table.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}let sketch={tx:null,ty:null,s:1,ox:0,oy:0,hitPts:[],hitSegs:[],errSeg:null};function drawSketch(oPts,aPts,stats){last.origPts=oPts||[];last.adjPts=aPts||null;const c=$('sketch');const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);const all=[...(oPts||[]),...(aPts||[])];if(!all.length){ctx.fillStyle='#9aa3af';ctx.fillText('No geometry to display',20,24);return}const b=bounds(all),pad=30,W=c.width-pad*2,H=c.height-pad*2,s=Math.min(W/Math.max(1,(b.maxX-b.minX)),H/Math.max(1,(b.maxY-b.minY)));const ox=pad-b.minX*s,oy=c.height-pad+b.minY*s;sketch.s=s;sketch.ox=ox;sketch.oy=oy;const tx=x=>ox+x*s,ty=y=>oy-y*s;sketch.tx=tx;sketch.ty=ty;ctx.lineWidth=1;ctx.strokeStyle='rgba(0,0,0,0.05)';ctx.beginPath();ctx.moveTo(pad,c.height-pad);ctx.lineTo(c.width-pad,c.height-pad);ctx.stroke();ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,c.height-pad);ctx.stroke();const drawPoly=(arr,styleDash=false,color='rgba(239,68,68,0.9)',lw=2)=>{if(arr.length<1)return;ctx.setLineDash(styleDash?[6,6]:[]);ctx.strokeStyle=color;ctx.lineWidth=lw;ctx.beginPath();ctx.moveTo(tx(arr[0].x),ty(arr[0].y));for(let i=1;i<arr.length;i++)ctx.lineTo(tx(arr[i].x),ty(arr[i].y));ctx.stroke();ctx.setLineDash([]);ctx.fillStyle=color;for(const p of arr){ctx.beginPath();ctx.arc(tx(p.x),ty(p.y),3,0,Math.PI*2);ctx.fill()}};if(oPts&&oPts.length){drawPoly(oPts,true,'rgba(239,68,68,0.9)',2)}if(aPts&&aPts.length){drawPoly(aPts,false,'rgba(16,185,129,0.95)',3)}sketch.hitPts=[];sketch.hitSegs=[];const active=aPts&&aPts.length?aPts:oPts;for(let i=0;i<active.length;i++){const p=active[i];sketch.hitPts.push({i,x:tx(p.x),y:ty(p.y),pt:p})}for(let i=0;i<active.length-1;i++){const a=active[i],b2=active[i+1];sketch.hitSegs.push({i,a:{x:tx(a.x),y:ty(a.y)},b:{x:tx(b2.x),y:ty(b2.y)},ptA:a,ptB:b2})}if(oPts&&oPts.length>=2){const sPt=oPts[0],ePt=oPts[oPts.length-1];const ex=tx(ePt.x),ey=ty(ePt.y),sx=tx(sPt.x),sy=ty(sPt.y);ctx.strokeStyle='rgba(239,68,68,0.95)';ctx.lineWidth=2.5;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(ex,ey);ctx.lineTo(sx,sy);ctx.stroke();ctx.setLineDash([]);const errLen=Math.hypot(ePt.x-sPt.x,ePt.y-sPt.y);ctx.fillStyle='rgba(239,68,68,0.95)';ctx.fillText('Error '+pretty(errLen,Math.max(last.prec.len,3)),(ex+sx)/2,(ey+sy)/2-6);sketch.errSeg={a:{x:ex,y:ey},b:{x:sx,y:sy},len:errLen}}}function distToSeg(px,py,x1,y1,x2,y2){const A=px-x1,B=py-y1,C=x2-x1,D=y2-y1;const dot=A*C+B*D;const len=C*C+D*D;let t=dot/len;t=Math.max(0,Math.min(1,t));const x=x1+t*C,y=y1+t*D;return Math.hypot(px-x,py-y)}function pickFeature(evt){const c=$('sketch');const r=c.getBoundingClientRect();const x=evt.clientX-r.left,y=evt.clientY-r.top;const tip=$('tip');const nearPt=sketch.hitPts.find(p=>Math.hypot(p.x-x,p.y-y)<8);if(nearPt){const i=nearPt.i;const active=last.adjPts&&last.adjPts.length?last.adjPts:last.origPts;const id=(coordRows[i]&&coordRows[i].id)||('P'+(i+1));const bearing=(i>0?bearingFromDXDY(active[i].x-active[i-1].x,active[i].y-active[i-1].y):(active[1]?bearingFromDXDY(active[1].x-active[0].x,active[1].y-active[0].y):0));tip.style.display='block';tip.style.left=(x+12)+'px';tip.style.top=(y+12)+'px';tip.textContent=`${id}: X=${pretty(active[i].x,last.prec.x)}, Y=${pretty(active[i].y,last.prec.y)}, Brg=${pretty(bearing,last.prec.ang)}¬∞`;return}const nearSeg=sketch.hitSegs.find(s=>distToSeg(x,y,s.a.x,s.a.y,s.b.x,s.b.y)<6);if(nearSeg){const L=Math.hypot(nearSeg.ptB.x-nearSeg.ptA.x,nearSeg.ptB.y-nearSeg.ptA.y);tip.style.display='block';tip.style.left=(x+12)+'px';tip.style.top=(y+12)+'px';tip.textContent=`Length ${pretty(L,Math.max(last.prec.len,3))}`;return}if(sketch.errSeg&&distToSeg(x,y,sketch.errSeg.a.x,sketch.errSeg.a.y,sketch.errSeg.b.x,sketch.errSeg.b.y)<6){tip.style.display='block';tip.style.left=(x+12)+'px';tip.style.top=(y+12)+'px';tip.textContent=`Error ${pretty(sketch.errSeg.len,Math.max(last.prec.len,3))}`;return}tip.style.display='none'}$('sketch').addEventListener('mousemove',pickFeature);$('sketch').addEventListener('click',pickFeature);function resetTool(){csvHeaders=[];csvRows=[];mapping={id:null,x:null,y:null};bearingRows.length=0;coordRows.length=0;renderBearingTable();renderCoordTable();setMode('coords');setCoordSub('manual');setCoordSys('utm');updateCoordLabels();$('csvFile').value='';$('mapInline').classList.add('hidden');$('mapMsg').textContent='';addCoordRow();$('dataError').classList.add('hidden');$('resultsError').classList.add('hidden');$('logBox').textContent='Ready.';$('commentary').textContent='';last={origLegs:[],adjLegs:null,origPts:[],adjPts:null,stats:{eX:0,eY:0,misclosure:0,Lsum:0},prec:{x:3,y:3,len:3,ang:2}};const ctx=$('sketch').getContext('2d');ctx.clearRect(0,0,$('sketch').width,$('sketch').height)}(function(){setMode('coords');setCoordSub('manual');updateCoordLabels();addCoordRow();fillSampleSelect();$('assumeClosed').addEventListener('change',()=>scheduleRecompute(false));const sx=$('startX'),sy=$('startY');if(sx)sx.addEventListener('input',()=>scheduleRecompute(false));if(sy)sy.addEventListener('input',()=>scheduleRecompute(false));const ro=new ResizeObserver(()=>{drawSketch(last.origPts,last.adjPts,last.stats)});ro.observe(document.body)})();</script></body></html>